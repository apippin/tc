#!/usr/bin/perl

use DBI;
use Getopt::Std;

$mydir = `cd \$(dirname $0) 2>/dev/null; pwd`; chomp($mydir);
unshift @INC,("$mydir/../setup");
if( -f "$mydir/../setup/db_config.local") { require "db_config.local"; }
else { require "db_config"; }

###################################################
# Connect to the database
$dbh=DBI->connect("dbi:mysql:dbname=$dbname:host=$dbhost:port=$dbport",$dbuser,$dbpass,{
    AutoCommit=>0,
    PrintError=>0}) or print "Connect Failure:".$DBI::errstr."\n" and exit 2;
###################################################

# Add a new 'aaronic' column to the eq_ppi table
$sth = $dbh->prepare("ALTER TABLE `eq_ppi` ADD `aaronic` INT( 16 ) NOT NULL DEFAULT '0' AFTER `elder`");
$sth->execute or die "-E- DB error: $DBI::errstr\n";

# Parse the data out of the eq_interview table and add them to the eq_ppi table
$sth = $dbh->prepare("select * from eq_interview");
$sth->execute or die "-E- DB error: $DBI::errstr\n";
while($row = $sth->fetchrow_hashref) {
    $interviewer = $row->{interviewer};
    $elder = $row->{elder};
    $aaronic = $row->{aaronic};
    $date = $row->{date};
    $notes = $row->{notes};
    $notes =~ s/\'/\\\'/g;
    $eqpresppi = 0;
    #print "$interviewer $elder $aaronic $date $eqpresppi $notes\n";
    $sth2 = $dbh->prepare("insert into eq_ppi values (NULL,'$interviewer','$elder','$aaronic','$date','$notes','$eqpresppi')");
    $sth2->execute or die "-E- DB error: $DBI::errstr\n";
}

print "\n-> Succesfully imported all eq_interview table entries into eq_ppi table...\n";
print "-> You may drop the eq_interview table once you know all your data was transferred to the eq_ppi table correctly..\n";

###################################################
# Disconnect from the database
$dbh->disconnect();
###################################################


